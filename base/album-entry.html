<a href="/archives.html" class="back-link">← To All Archives</a>

<div class="entry-main">
  <div class="entry-header">
    <div class='entry-text-block'>
      <h1 class="entry-title" id="entry-title"></h1>
      <p class="entry-meta" id="entry-meta"></p>
      <div class="entry-description" id="entry-description"></div>
    </div>
    <div class="entry-gallery">
      <div class="thumbnail-image-wrapper">
        <button class="arrow left">←</button>
        <div id="main-media-placeholder"></div>
        <button class="arrow right">→</button>
        <span class="fullscreen-icon" id="fullscreen-toggle">⛶</span>
      </div>
    </div>
  </div>
  <div id="gallery-placeholder"></div>
</div>

<div id="motion-gallery-placeholder"></div>
<div id="related-links-placeholder"></div>

<div class="fullscreen-overlay" id="fullscreen-overlay">
  <div class="fullscreen-modal">
    <button class="fullscreen-close" id="fullscreen-close">×</button>
    <img src="" alt="Fullscreen Image" id="fullscreen-image" />
    <p class="fullscreen-caption" id="fullscreen-caption"></p>
    <button class="fullscreen-nav-arrow left" id="fullscreen-prev">←</button>
    <button class="fullscreen-nav-arrow right" id="fullscreen-next">→</button>
  </div>
</div>

<script>
  window.addEventListener('load', () => {
    window.scrollTo(0, 0);
  });
  
  // This part of the script will be executed once the album-entry.html content is loaded
  const contentfulURL = `https://cdn.contentful.com/spaces/${spaceId}/environments/master/entries?access_token=${accessToken}&sys.id=${entryId}&include=2`;
  
  fetch(contentfulURL)
    .then(res => res.json())
    .then(data => {
      const entry = data.items[0];
      const fields = entry.fields;
      const includes = data.includes;

      document.title = `${fields.title || 'Untitled'} | Bay Islands Archives`;

      // Helper function to resolve assets and entries
      const assetsMap = {};
      includes?.Asset?.forEach(asset => {
        if (asset.sys.id && asset.fields?.file?.url) {
          assetsMap[asset.sys.id] = {
            url: `https:${asset.fields.file.url}`,
            description: asset.fields.description || '',
            contentType: asset.fields.file.contentType
          };
        }
      });
      
      const relatedEntriesMap = {};
      includes?.Entry?.forEach(e => {
        relatedEntriesMap[e.sys.id] = e;
      });

      // Populate main content
      document.getElementById('entry-title').textContent = fields.title || 'Untitled';
      const date = fields.date ? new Date(fields.date).getFullYear() : 'Unknown Year';
      const locationName = relatedEntriesMap[fields.location?.sys?.id]?.fields.geolocation || 'Unknown Location';
      const islandName = relatedEntriesMap[relatedEntriesMap[fields.location?.sys?.id]?.fields.island?.sys?.id]?.fields.island || '';
      document.getElementById('entry-meta').innerHTML = `${locationName}${islandName ? ', ' + islandName : ''}<br>${date}`;
      if (fields.description?.content?.[0]?.content?.[0]?.value) {
        document.getElementById('entry-description').textContent = fields.description.content[0].content[0].value;
      }

      // Populate main media and gallery
      const allImagesForGallery = [];
      const mainMediaPlaceholder = document.getElementById('main-media-placeholder');
      const galleryPlaceholder = document.getElementById('gallery-placeholder');

      if (fields.imageGallery?.length) {
          fields.imageGallery.forEach(img => {
            if (img.sys?.id) {
              const galleryAsset = assetsMap[img.sys.id];
              if (galleryAsset && galleryAsset.contentType.startsWith('image/')) {
                allImagesForGallery.push(galleryAsset);
              }
            }
          });
      }

      let mainImageHtml = `<img src="https://placehold.co/600x400?text=No+Image" id="main-image" class="thumbnail-image" alt="No image available" />`;
      if (fields.thumbnailImage?.sys?.id) {
        const thumbAsset = assetsMap[fields.thumbnailImage.sys.id];
        if (thumbAsset && thumbAsset.contentType.startsWith('image/')) {
            mainImageHtml = `<img src="${thumbAsset.url}" id="main-image" class="thumbnail-image" alt="${thumbAsset.description || fields.title}" />`;
            const isThumbInGallery = allImagesForGallery.some(img => img.url === thumbAsset.url);
            if (!isThumbInGallery) {
                allImagesForGallery.unshift(thumbAsset);
            }
        }
      }
      mainMediaPlaceholder.innerHTML = mainImageHtml;

      if (allImagesForGallery.length > 0) {
        let galleryHtml = `<div class="gallery-wrapper">
            <button class="thumb-arrow thumb-left">←</button>
            <div class="thumbnail-viewport">
                <div class="image-gallery" id="image-gallery">
                    ${allImagesForGallery.map((imgData, i) => `<img class="thumb ${i === 0 ? 'selected' : ''}" src="${imgData.url}" data-index="${i}" alt="${imgData.description || 'Thumbnail image'}" />`).join('')}
                </div>
            </div>
            <button class="thumb-arrow thumb-right">→</button>
        </div>`;
        galleryPlaceholder.innerHTML = galleryHtml;
      }
      
      // Fullscreen and Gallery Logic (this part remains largely the same)
      const fullscreenOverlay = document.getElementById('fullscreen-overlay');
      const fullscreenImage = document.getElementById('fullscreen-image');
      const fullscreenCaption = document.getElementById('fullscreen-caption');
      const fullscreenClose = document.getElementById('fullscreen-close');
      const fullscreenPrev = document.getElementById('fullscreen-prev');
      const fullscreenNext = document.getElementById('fullscreen-next');
      const mainImage = document.getElementById('main-image');
      const fullscreenToggle = document.getElementById('fullscreen-toggle');
      const thumbs = document.querySelectorAll('.image-gallery img');

      let currentIndex = 0;
      
      const updateImage = (index) => {
          currentIndex = (index + allImagesForGallery.length) % allImagesForGallery.length;
          mainImage.src = allImagesForGallery[currentIndex].url;
          mainImage.alt = allImagesForGallery[currentIndex].description || '';
          thumbs.forEach(el => el.classList.remove('selected'));
          if (thumbs[currentIndex]) {
              thumbs[currentIndex].classList.add('selected');
          }
      };

      const openFullscreen = (index) => {
          fullscreenOverlay.innerHTML = `<div class="fullscreen-modal">
                <button class="fullscreen-close" id="fullscreen-close">×</button>
                <img src="${allImagesForGallery[index].url}" alt="Fullscreen Image" id="fullscreen-image" />
                <p class="fullscreen-caption" id="fullscreen-caption">${allImagesForGallery[index].description || ''}</p>
                <button class="fullscreen-nav-arrow left" id="fullscreen-prev">←</button>
                <button class="fullscreen-nav-arrow right" id="fullscreen-next">→</button>
              </div>`;
          fullscreenOverlay.classList.add('visible');
          document.body.style.overflow = 'hidden';
      };

      // Event listeners
      if (mainImage) mainImage.addEventListener('click', () => openFullscreen(currentIndex));
      if (fullscreenToggle) fullscreenToggle.addEventListener('click', () => openFullscreen(currentIndex));
      thumbs.forEach((thumb, index) => thumb.addEventListener('click', () => updateImage(index)));
      document.querySelector('.arrow.left')?.addEventListener('click', () => updateImage(currentIndex - 1));
      document.querySelector('.arrow.right')?.addEventListener('click', () => updateImage(currentIndex + 1));
      
      fullscreenOverlay.addEventListener('click', (e) => {
        if (e.target.id === 'fullscreen-close' || e.target.classList.contains('fullscreen-overlay')) {
            fullscreenOverlay.classList.remove('visible');
            document.body.style.overflow = '';
        }
        if (e.target.id === 'fullscreen-prev') {
            currentIndex = (currentIndex - 1 + allImagesForGallery.length) % allImagesForGallery.length;
            openFullscreen(currentIndex);
        }
        if (e.target.id === 'fullscreen-next') {
            currentIndex = (currentIndex + 1) % allImagesForGallery.length;
            openFullscreen(currentIndex);
        }
      });
    
      // Motion Gallery and Related Links... (similar logic, simplified here for brevity)
    })
    .catch(err => console.error('Error fetching album entry:', err));
</script>