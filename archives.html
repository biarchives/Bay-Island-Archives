<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bay Islands Archives</title>
  <link rel="stylesheet" href="css/archives.css" />
</head>

<body>
  <!-- Header -->
  <div id="header-placeholder"></div>

  <!-- Main -->
  <main class="site-main">
    <h2>All Archives</h2>
    <p class="description">
      Browse all archives available for the Bay Islands. Click the island below if you want to
      view a specific islandâ€™s records, and click on the side for more advanced sorting options.
    </p>
    <div class="search-container">
      <input type="text" id="search-input" class="search-bar" placeholder="Search archives by title..." />
      <!-- Sorting Controls -->
      <div class="sort-controls">
        <select id="sort-date">
          <option value="">Sort by Date</option>
          <option value="asc">Oldest First</option>
          <option value="desc">Newest First</option>
        </select>
        <select id="sort-name">
          <option value="">Sort by Name</option>
          <option value="asc">Aâ€“Z</option>
          <option value="desc">Zâ€“A</option>
        </select>
      </div>
      <!-- Filters Sidebar -->
      <aside class="filters">
        <div class="filter-section">
          <h2>Islands</h2>
          <div class="filter-tags">
            <button data-filter-type="location" data-value="RoatÃ¡n">RoatÃ¡n</button>
            <button data-filter-type="location" data-value="Morat">Morat</button>
            <button data-filter-type="location" data-value="Guanaja">Guanaja</button>
            <button data-filter-type="location" data-value="Barbareta">Barbareta</button>
            <button data-filter-type="location" data-value="Utila">Utila</button>
            <button data-filter-type="location" data-value="Cochinos PequeÃ±o">Cochinos PequeÃ±o</button>
            <button data-filter-type="location" data-value="Cochinos Grande">Cochinos Grande</button>
          </div>
        </div>

        <div class="filter-section">
          <h2>Item Type</h2>
          <div class="filter-tags">
            <div class="filter-tags">
              <button data-filter-type="type" data-value="image">ðŸ–¼ Image</button>
              <button data-filter-type="type" data-value="text">ðŸ…£ Text</button>
              <button data-filter-type="type" data-value="video">ðŸŽ¥ Video</button>
              <button data-filter-type="type" data-value="audio">ðŸ”Š Audio</button>
            </div>
          </div>
        </div>
        <button onclick="resetFilters()">Reset Filters</button>

      </aside>

      <!-- Archive Grid -->
      <section class="archive-grid">

      </section>
    </div>
    </div>
  </main>

  <!-- Footer -->
  <div id="footer-placeholder"></div>
</body>

<script>
  // Load the header
  fetch('base/header.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('header-placeholder').innerHTML = data;
    });

  // Load the footer
  fetch('base/footer.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('footer-placeholder').innerHTML = data;
    });

  const spaceId = 'yp5hut9gr3i4';
  const accessToken = '6cmQ6BIqhbITci25VJRJxasRNDvkKb_74mYDBAKfPdY';
  const contentTypes = ['archivePage', 'singleEntry'];

  const activeFilters = {
    location: new Set(),
    type: new Set()
  };

  Promise.all(
    contentTypes.map(type =>
      fetch(`https://cdn.contentful.com/spaces/${spaceId}/environments/master/entries?access_token=${accessToken}&content_type=${type}&include=2`)
        .then(res => res.json())
    )
  )
    .then(data => {
      const [archivePageData, singleEntryData] = data;
      const allItems = [...archivePageData.items, ...singleEntryData.items];

      const allAssets = [
        ...(archivePageData.includes?.Asset || []),
        ...(singleEntryData.includes?.Asset || [])
      ];
      const allEntries = [
        ...(archivePageData.includes?.Entry || []),
        ...(singleEntryData.includes?.Entry || [])
      ];

      const grid = document.querySelector('.archive-grid');

      // Create a map for quick asset lookup
      const assetsMap = {};
      allAssets.forEach(asset => {
        if (asset.sys.id && asset.fields?.file?.url) {
          assetsMap[asset.sys.id] = {
            url: `https:${asset.fields.file.url}`,
            description: asset.fields.description || '',
            contentType: asset.fields.file.contentType // Store contentType for filtering
          };
        }
      });

      allItems.forEach(item => {
        const fields = item.fields;
        const contentTypeId = item.sys.contentType.sys.id; // Get the content type ID
        const title = fields.title || 'Untitled';
        const date = fields.date ? new Date(fields.date).getFullYear() : 'Unknown year';

        // Resolve Location Field
        let locationText = 'Unknown location';
        let islandText = 'unknown';

        if (fields.location?.sys?.id) {
          const locationEntry = allEntries.find(e => e.sys.id === fields.location.sys.id);

          if (locationEntry?.fields) {
            const geoName = locationEntry.fields.geolocation || '';
            const islandRef = locationEntry.fields.island;

            if (islandRef?.sys?.id) {
              const islandEntry = allEntries.find(e => e.sys.id === islandRef.sys.id);
              let islandName = islandEntry?.fields?.island || 'Unknown island';

              locationText = `${geoName}, ${islandName}`;
              islandText = islandName;
            } else if (geoName) {
              locationText = geoName;
            }
          }
        }

        const safeIslandText = typeof islandText === 'string' ? islandText.toLowerCase() : 'unknown';

        // --- DYNAMIC THUMBNAIL AND TYPE LOGIC ---
        function extractYouTubeVideoId(url) {
          const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
          const match = url.match(regex);
          return (match && match[1]) ? match[1] : null;
        }

        let imageUrl = null; // Changed to null to allow for no image
        let imageAlt = `${title} - No Image`;
        let itemType = 'unknown'; // Default item type for filtering

        if (contentTypeId === 'archivePage' && fields.thumbnailImage?.sys?.id) {
          // Logic for 'Album Entry' (archivePage)
          const thumbAsset = assetsMap[fields.thumbnailImage.sys.id];
          if (thumbAsset) {
            imageUrl = thumbAsset.url;
            imageAlt = thumbAsset.description || title;
            if (thumbAsset.contentType.startsWith('image')) {
              itemType = 'image';
            }
          }
        } else if (contentTypeId === 'singleEntry' && fields.media?.sys?.id) {
          // Logic for 'Single Entry'
          const mediaAsset = assetsMap[fields.media.sys.id];
          if (mediaAsset) {
            if (mediaAsset.contentType.startsWith('image')) {
              imageUrl = mediaAsset.url;
              imageAlt = mediaAsset.description || title;
              itemType = 'image';
            } else if (mediaAsset.contentType.startsWith('video')) {
              // Use a placeholder for video thumbnails if a separate thumbnail isn't provided
              imageUrl = 'https://via.placeholder.com/300x200?text=Video+Entry';
              imageAlt = `Video: ${title}`;
              itemType = 'video';
            } else if (mediaAsset.contentType.startsWith('audio')) {
              // Use a placeholder for audio thumbnails
              imageUrl = 'https://via.placeholder.com/300x200?text=Audio+Entry';
              imageAlt = `Audio: ${title}`;
              itemType = 'audio';
            }
          }
        } else if (contentTypeId === 'singleEntry' && fields.externalUrl) {
          // CORRECTED Logic for external URL entry (YouTube thumbnail)
          const videoId = extractYouTubeVideoId(fields.externalUrl);
          if (videoId) {
            // Correct and reliable YouTube thumbnail URL
            imageUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
            imageAlt = `YouTube Video: ${title}`;
            itemType = 'video';
          } else {
            // Fallback for non-YouTube external URLs
            imageUrl = 'https://via.placeholder.com/300x200?text=External+URL';
            imageAlt = `External Link: ${title}`;
            itemType = 'link'; // A new type for non-video external links
          }
        }
        // --- END DYNAMIC THUMBNAIL AND TYPE LOGIC ---

        // The rest of your code for creating the div and populating it
        const div = document.createElement('div');
        div.className = 'archive-item';
        div.setAttribute('data-title', title.toLowerCase());
        div.setAttribute('data-date', date);
        div.setAttribute('data-location', safeIslandText);
        div.setAttribute('data-type', itemType);

        // Conditionally add the image
        let imageHtml = '';
        if (imageUrl) {
          imageHtml = `<img src="${imageUrl}" alt="${imageAlt}">`;
        }

        div.innerHTML = `
          <a href="entry.html?id=${item.sys.id}">
            ${imageHtml}
            <div class="item-text">
              <strong>${title}</strong><br />
              ${locationText}<br/>
              ${date}
            </div>
          </a>
        `;

        grid.appendChild(div);
      });

      // FILTER HANDLERS
      function applyFilters() {
        const items = document.querySelectorAll('.archive-item');
        items.forEach(item => {
          const matchesLocation = activeFilters.location.size === 0 || activeFilters.location.has(item.dataset.location);
          const matchesType = activeFilters.type.size === 0 || activeFilters.type.has(item.dataset.type);
          item.style.display = (matchesLocation && matchesType) ? 'block' : 'none';
        });
      }

      document.querySelectorAll('.filter-tags button').forEach(button => {
        button.addEventListener('click', () => {
          const type = button.dataset.filterType;
          const value = button.dataset.value.toLowerCase();
          if (!activeFilters[type]) return;

          // Special handling for item types with multiple values
          if (type === 'type') {
            const hasActiveType = Array.from(activeFilters.type).includes(value);
            if (hasActiveType) {
              activeFilters.type.clear();
            } else {
              activeFilters.type.clear();
              activeFilters.type.add(value);
            }
            document.querySelectorAll('.filter-tags button[data-filter-type="type"]').forEach(btn => {
              btn.classList.remove('active-filter');
            });
            if (!hasActiveType) {
              button.classList.add('active-filter');
            }
          } else {
            // Regular toggle for other filters
            if (activeFilters[type].has(value)) {
              activeFilters[type].delete(value);
              button.classList.remove('active-filter');
            } else {
              activeFilters[type].add(value);
              button.classList.add('active-filter');
            }
          }
          applyFilters();
        });
      });

      // SORTING
      function sortItems(by, direction) {
        const items = Array.from(grid.children);
        items.sort((a, b) => {
          const valA = a.dataset[by];
          const valB = b.dataset[by];
          if (by === 'date') {
            return direction === 'asc' ? valA - valB : valB - valA;
          } else {
            return direction === 'asc'
              ? valA.localeCompare(valB)
              : valB.localeCompare(valA);
          }
        });
        items.forEach(item => grid.appendChild(item));
      }

      document.getElementById('sort-date').addEventListener('change', e => {
        if (e.target.value) sortItems('date', e.target.value);
      });
      document.getElementById('sort-name').addEventListener('change', e => {
        if (e.target.value) sortItems('title', e.target.value);
      });

      // SEARCH
      const searchInput = document.getElementById('search-input');
      function performSearch() {
        const query = searchInput.value.trim().toLowerCase();
        const items = document.querySelectorAll('.archive-item');
        items.forEach(item => {
          const title = item.dataset.title || '';
          item.style.display = title.includes(query) ? 'block' : 'none';
        });
      }
      searchInput.addEventListener('input', performSearch);

      // RESET FILTERS
      function resetFilters() {
        Object.keys(activeFilters).forEach(type => activeFilters[type].clear());
        document.querySelectorAll('.archive-item').forEach(item => {
          item.style.display = 'block';
        });
        document.querySelectorAll('.filter-tags button').forEach(button => {
          button.classList.remove('active-filter');
        });
      }
      // You'll likely need a button to call resetFilters, e.g.:
      // document.getElementById('reset-filters-button').addEventListener('click', resetFilters);
    })
    .catch(error => {
      console.error('Contentful error:', error);
    });
</script>

</body>

</html>