<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bay Islands Archives</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="preload" href="fonts/OdibeeSans-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="fonts/PTMono-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">


  <!-- Mapbox GL JS CDN -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

</head>

<body>
  <div class="page-wrapper">
    <header class="site-header">
      <div class="header-content">
        <a href="index.html" class="site-title">Bay Islands Archives</a>
        <nav class="nav-links">
          <a href="about.html">About</a>
          <a href="archives.html">Archives</a>
          <a href="contact.html">Contact</a>
        </nav>
      </div>
    </header>

    <main class="site-main">
      <div class="main-text">
        <h1>Explore the history of the Bay Islands</h1>
        <p>Examine the rich history and diverse cultures of the Bay Islands through our interactive map and archives.
        </p>
        <p>Click on an island or location to discover stories, photos, and more.</p>
      </div>
      <div class="main-content">
        <div id="sidebar" class="hidden">
          <button id="back-button">← Back to Map</button>
          <h2 id="sidebar-title"></h2>
          <h3 id="sidebar-subtitle"></h3>
          <p id="sidebar-description"></p>
          <h3>Explore Archives</h3>
          <div id="archive-buttons"> </div>
        </div>
        <!-- Archive Overlay -->
        <div id="archive-overlay" class="hidden">
          <div class="overlay-content">
            <div id="archive-previews"></div>
            <!-- JS will populate this with archive previews -->
          </div>
        </div>

        <div id="map" class="map-container"></div>
      </div>


    </main>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-left">
        <p>Preserving stories, honoring history.</p>
        <h2>Bay Island Archives</h2>
        <div class="footer-links">
          <a href="about.html">About</a>
          <a href="archives.html">Archives</a>
          <a href="contact.html">Contact</a>
        </div>
      </div>
      <div class="footer-center">
        <form class="newsletter-form">
          <label for="email">Stay in touch.</label>
          <div class="newsletter-inputs">
            <input type="email" id="email" placeholder="Enter your email" required />
            <button type="submit">Subscribe</button>
          </div>
        </form>
      </div>
    </div>
  </footer>
</body>

<script>
  const spaceId = 'yp5hut9gr3i4';
  const accessToken = '6cmQ6BIqhbITci25VJRJxasRNDvkKb_74mYDBAKfPdY';
  // Use both content types to ensure all entries are fetched
  const contentTypes = ['archivePage', 'singleEntry'];

  let allEntries = [];
  let allRelatedEntries = [];
  let allAssets = [];
  let islandCounts = {};
  let locationCounts = {};
  let lastSelectedIsland = null;

  async function fetchAllEntries() {
    const responses = await Promise.all(
      contentTypes.map(type =>
        fetch(`https://cdn.contentful.com/spaces/${spaceId}/environments/master/entries?access_token=${accessToken}&content_type=${type}&include=2`)
          .then(res => res.json())
      )
    );

    let allItems = [];
    responses.forEach(data => {
      allItems.push(...(data.items || []));
      allRelatedEntries.push(...(data.includes?.Entry || []));
      allAssets.push(...(data.includes?.Asset || []));
    });

    return allItems;
  }

  function resolveLocationAndIsland(entry) {
    let locationName = 'unknown location';
    let islandName = 'unknown island';
    let safeIslandText = 'unknown';

    if (entry.fields.location?.sys?.id) {
      const locationEntry = allRelatedEntries.find(e => e.sys.id === entry.fields.location.sys.id);

      if (locationEntry?.fields) {
        locationName = locationEntry.fields.geolocation || 'unknown location';
        const islandRef = locationEntry.fields.island;

        if (islandRef?.sys?.id) {
          const islandEntry = allRelatedEntries.find(e => e.sys.id === islandRef.sys.id);
          islandName = islandEntry?.fields?.island || 'unknown island';
          safeIslandText = islandName.toLowerCase();
        } else if (locationName) {
          safeIslandText = locationName.toLowerCase();
        }
      }
    }
    return { locationName, islandName, safeIslandText };
  }

  function groupEntries(entries) {
    const islandCounts = {};
    const locationCounts = {};

    entries.forEach(entry => {
      const { locationName, safeIslandText } = resolveLocationAndIsland(entry);

      // Use locationName as key for locationCounts
      if (!locationCounts[locationName.toLowerCase()]) {
        locationCounts[locationName.toLowerCase()] = { total: 0, albums: 0, photos: 0, videos: 0, audio: 0, text: 0 };
      }

      // Use safeIslandText as key for islandCounts
      if (!islandCounts[safeIslandText]) {
        islandCounts[safeIslandText] = { total: 0, albums: 0, photos: 0, videos: 0, audio: 0, text: 0 };
      }

      const type = entry.fields.fileType?.toLowerCase() || 'unknown';

      islandCounts[safeIslandText].total++;
      locationCounts[locationName.toLowerCase()].total++;

      if (type && islandCounts[safeIslandText][type] !== undefined) {
        islandCounts[safeIslandText][type]++;
      }
      if (type && locationCounts[locationName.toLowerCase()][type] !== undefined) {
        locationCounts[locationName.toLowerCase()][type]++;
      }
    });

    return { islandCounts, locationCounts };
  }

  function renderPreviewItems(entries) {
    const previewContainer = document.getElementById('archive-previews');
    previewContainer.innerHTML = '';

    if (entries.length === 0) {
      previewContainer.innerHTML = '<p>No entries found.</p>';
      return;
    }

    entries.forEach(item => {
      const fields = item.fields;
      const title = fields.title || 'Untitled';
      const date = fields.date ? new Date(fields.date).getFullYear() : 'Unknown year';

      const { locationName, islandName } = resolveLocationAndIsland(item);
      const locationText = `${locationName}, ${islandName}`;

      let imageUrl = 'https://via.placeholder.com/300x200?text=No+Image';

      // Thumbnail Image Logic: Prioritize media, then thumbnailImage, then imageGallery
      if (fields.media?.sys?.id) {
        const mediaAsset = allAssets.find(a => a.sys.id === fields.media.sys.id);
        if (mediaAsset?.fields?.file?.url && mediaAsset.fields.file.contentType.startsWith('image/')) {
          imageUrl = `https:${mediaAsset.fields.file.url}`;
        }
      } else if (fields.thumbnailImage?.sys?.id) {
        const thumbAsset = allAssets.find(a => a.sys.id === fields.thumbnailImage.sys.id);
        if (thumbAsset?.fields?.file?.url) {
          imageUrl = `https:${thumbAsset.fields.file.url}`;
        }
      } else if (fields.imageGallery?.length) {
        const firstGalleryImage = allAssets.find(a => a.sys.id === fields.imageGallery[0].sys.id);
        if (firstGalleryImage?.fields?.file?.url) {
          imageUrl = `https:${firstGalleryImage.fields.file.url}`;
        }
      }

      const cardLink = document.createElement('a');
      cardLink.href = `entry.html?id=${item.sys.id}`;
      cardLink.className = 'archive-card';
      cardLink.innerHTML = `
        <img src="${imageUrl}" alt="${title}" />
        <div class="card-text">
          <h3>${title}</h3>
          <p>${date} — ${locationText}</p>
        </div>
      `;
      previewContainer.appendChild(cardLink);
    });
  }

  mapboxgl.accessToken = 'pk.eyJ1IjoiYmlhcmNoaXZlcyIsImEiOiJjbWRtZDRmMjIxa3JlMmpxMWIyM2ZleHVoIn0.qAlCMwvS56lvr7AbC2Iuug';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/biarchives/cmdop5iqf01vp01sa2ol5fds9',
    center: [-86.57845621839104, 16.29814507230684],
    zoom: 9
  });

  map.addControl(new mapboxgl.NavigationControl());
  map.scrollZoom.disable();

  function attachButtonListeners(selectedName, type) {
    const buttons = document.querySelectorAll('#archive-buttons button');
    buttons.forEach(button => {
      button.addEventListener('click', () => {
        const filterType = button.dataset.filterType;
        let filteredEntries = [];

        if (type === 'island') {
          filteredEntries = allEntries.filter(entry => {
            const { safeIslandText } = resolveLocationAndIsland(entry);
            const matchesIsland = safeIslandText === selectedName;
            const matchesType = filterType === 'all' || (entry.fields.fileType?.toLowerCase() === filterType);
            return matchesIsland && matchesType;
          });
        } else if (type === 'location') {
          filteredEntries = allEntries.filter(entry => {
            const { locationName } = resolveLocationAndIsland(entry);
            const matchesLocation = locationName.toLowerCase() === selectedName;
            const matchesType = filterType === 'all' || (entry.fields.fileType?.toLowerCase() === filterType);
            return matchesLocation && matchesType;
          });
        }

        renderPreviewItems(filteredEntries);
        document.getElementById('archive-overlay').classList.remove('hidden');
      });
    });
  }

  map.on('load', async () => {
    allEntries = await fetchAllEntries();
    const { islandCounts, locationCounts } = groupEntries(allEntries);

    const hoverPopup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });

    map.on('mouseenter', 'bay-island-islands-fill', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'bay-island-islands-fill', () => map.getCanvas().style.cursor = '');
    map.on('mouseenter', 'biarchives-geolocations', (e) => {
      const coordinates = e.features[0].geometry.coordinates.slice();
      const locationName = e.features[0].properties.location || "Unnamed Location";
      hoverPopup.setLngLat(coordinates).setHTML(`<strong>${locationName}</strong>`).addTo(map);
    });
    map.on('mouseleave', 'biarchives-geolocations', () => hoverPopup.remove());

    map.on('click', 'bay-island-islands-fill', (e) => {
      const props = e.features[0].properties;
      const island = props.island?.toLowerCase().trim();
      const stats = islandCounts[island] || { total: 0, albums: 0, photos: 0, videos: 0, audio: 0, text: 0 };

      document.getElementById('sidebar-title').textContent = props.island || "Unknown Island";
      document.getElementById('sidebar-subtitle').textContent = "";
      document.getElementById('sidebar-description').textContent = props.description || "No description available.";

      document.getElementById('archive-buttons').innerHTML = `
        <button id="btn-all" data-filter-type="all">View All (${stats.total})</button>
        <button id="btn-albums" data-filter-type="albums">Albums (${stats.albums})</button>
        <button id="btn-photos" data-filter-type="photos">Photos (${stats.photos})</button>
        <button id="btn-videos" data-filter-type="videos">Videos (${stats.videos})</button>
        <button id="btn-audio" data-filter-type="audio">Audio (${stats.audio})</button>
        <button id="btn-text" data-filter-type="text">Text (${stats.text})</button>
      `;
      document.getElementById('sidebar').classList.remove('hidden');
      attachButtonListeners(island, 'island');
    });

    map.on('click', 'biarchives-geolocations', (e) => {
      const props = e.features[0].properties;
      const location = props.location?.toLowerCase().trim();
      const stats = locationCounts[location] || { total: 0, albums: 0, photos: 0, videos: 0, audio: 0, text: 0 };

      document.getElementById('sidebar-title').textContent = props.location || "Untitled Location";
      document.getElementById('sidebar-subtitle').textContent = props.island || "";
      document.getElementById('sidebar-description').textContent = props.description || "No description available.";

      document.getElementById('archive-buttons').innerHTML = `
        <button id="btn-all" data-filter-type="all">View All (${stats.total})</button>
        <button id="btn-albums" data-filter-type="albums">Albums (${stats.albums})</button>
        <button id="btn-photos" data-filter-type="photos">Photos (${stats.photos})</button>
        <button id="btn-videos" data-filter-type="videos">Videos (${stats.videos})</button>
        <button id="btn-audio" data-filter-type="audio">Audio (${stats.audio})</button>
        <button id="btn-text" data-filter-type="text">Text (${stats.text})</button>
      `;
      document.getElementById('sidebar').classList.remove('hidden');
      attachButtonListeners(location, 'location');
    });

    document.getElementById('back-button').addEventListener('click', () => {
      document.getElementById('sidebar').classList.add('hidden');
      document.getElementById('archive-previews').innerHTML = '';
      const overlay = document.getElementById('archive-overlay');
      overlay.classList.add('hidden');
      overlay.style.display = '';
    });
  });
</script>

</html>