<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bay Islands Archives</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="preload" href="fonts/OdibeeSans-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="fonts/PTMono-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">


  <!-- Mapbox GL JS CDN -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

</head>

<body>
  <div class="page-wrapper">
    <header class="site-header">
      <div class="header-content">
        <a href="index.html" class="site-title">Bay Islands Archives</a>
        <nav class="nav-links">
          <a href="about.html">About</a>
          <a href="archives.html">Archives</a>
          <a href="contact.html">Contact</a>
        </nav>
      </div>
    </header>

    <main class="site-main">
      <div class="main-text">
        <h1>Explore the history of the Bay Islands</h1>
        <p id='disclaimed'>We recognize The Pech people as the indigenous people of the Bay Islands of Honduras. They
          were
          a nomadic tribe, with roots throughout Central America. </p>
      </div>
      <div class="main-content">
        <div id="map-menu">
  <button id="menu-toggle-button" aria-expanded="false" aria-controls="menu-content">All Locations</button>
  <div id="menu-content" class="menu-content" aria-hidden="true">
    <ul id="island-list" class="island-list">
      </ul>
  </div>
</div>
        <div id="sidebar" class="hidden" aria-hidden="true">
          <button id="back-button">‚Üê Back to Map</button>
          <h2 id="sidebar-title"></h2>
          <h3 id="sidebar-subtitle"></h3>
          <p id="sidebar-description"></p>
          <h3>Explore Archives</h3>
          <div id="archive-buttons"> </div>
        </div>
        <!-- Archive Overlay -->
        <div id="archive-overlay" class="hidden" aria-hidden="true">
          <div class="overlay-content">
            <div id="archive-previews" role="status" aria-live="polite"></div>
            <!-- JS will populate this with archive previews -->
          </div>
        </div>

        <div id="map" class="map-container"></div>
      </div>


    </main>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-left">
        <p>Preserving stories, honoring history.</p>
        <h2>Bay Island Archives</h2>
        <div class="footer-links">
          <a href="about.html">About</a>
          <a href="archives.html">Archives</a>
          <a href="contact.html">Contact</a>
        </div>
      </div>
      <div class="footer-center">
        <form class="newsletter-form">
          <label for="email">Stay in touch.</label>
          <div class="newsletter-inputs">
            <input type="email" id="email" placeholder="Enter your email" required />
            <button type="submit">Subscribe</button>
          </div>
        </form>
      </div>
    </div>
  </footer>
</body>

<script>
  const spaceId = 'yp5hut9gr3i4';
  const accessToken = '6cmQ6BIqhbITci25VJRJxasRNDvkKb_74mYDBAKfPdY';
  const contentTypes = ['archivePage', 'singleEntry'];

  let allEntries = [];
  let allRelatedEntries = [];
  let allAssets = [];
  let islandCounts = {};
  let locationCounts = {};
  let lastSelectedIsland = null;

  const defaultCenter = [-86.326, 16.125];
  const defaultZoom = 9;

  async function fetchAllEntries() {
    const responses = await Promise.all(
      contentTypes.map(type =>
        fetch(`https://cdn.contentful.com/spaces/${spaceId}/environments/master/entries?access_token=${accessToken}&content_type=${type}&include=2`)
          .then(res => res.json())
      )
    );

    let allItems = [];
    responses.forEach(data => {
      allItems.push(...(data.items || []));
      allRelatedEntries.push(...(data.includes?.Entry || []));
      allAssets.push(...(data.includes?.Asset || []));
    });

    return allItems;
  }

  function resolveLocationAndIsland(entry) {
    let locationsData = [];
    const locationRefs = entry.fields.location;

    const locationsArray = Array.isArray(locationRefs) ? locationRefs : (locationRefs ? [locationRefs] : []);

    if (locationsArray.length > 0) {
      locationsArray.forEach(locationRef => {
        const locationEntry = allRelatedEntries.find(e => e.sys.id === locationRef.sys.id);
        if (locationEntry?.fields && locationEntry.sys.contentType) {
          const contentTypeId = locationEntry.sys.contentType.sys.id;
          let locationName = 'Unknown Location';
          let islandName = 'Unknown Island';
          let safeIslandText = 'unknown';

          if (contentTypeId === 'geolocation') {
            const islandRef = locationEntry.fields.island;
            if (islandRef?.sys?.id) {
              const islandEntry = allRelatedEntries.find(e => e.sys.id === islandRef.sys.id);
              islandName = islandEntry?.fields?.island || 'Unknown Island';
            }
            if (locationEntry.fields.geolocation) {
              locationName = locationEntry.fields.geolocation;
            } else {
              locationName = islandName;
            }
            safeIslandText = islandName.toLowerCase();
          } else if (contentTypeId === 'island') {
            islandName = locationEntry.fields.island || 'Unknown Island';
            locationName = islandName;
            safeIslandText = islandName.toLowerCase();
          }

          locationsData.push({ locationName, islandName, safeIslandText, coordinates: locationEntry.fields.coordinates, description: locationEntry.fields.description });
        }
      });
    } else {
      locationsData.push({ locationName: 'Unknown Location', islandName: 'Unknown Island', safeIslandText: 'unknown', coordinates: null, description: null });
    }
    return locationsData;
  }

  function groupEntries(entries) {
    const newIslandCounts = {};
    const newLocationCounts = {};

    entries.forEach(entry => {
      const locationsData = resolveLocationAndIsland(entry);
      const contentTypeId = entry.sys.contentType.sys.id;
      let type = 'unknown';

      if (contentTypeId === 'archivePage') {
        type = 'albums';
      } else if (contentTypeId === 'singleEntry') {
        const mediaAsset = entry.fields.media?.sys?.id ? allAssets.find(a => a.sys.id === entry.fields.media.sys.id) : null;
        if (mediaAsset) {
          if (mediaAsset.fields.file.contentType.startsWith('video')) type = 'videos';
          else if (mediaAsset.fields.file.contentType.startsWith('audio')) type = 'audio';
          else if (mediaAsset.fields.file.contentType.includes('pdf')) type = 'documents';
          else if (mediaAsset.fields.file.contentType.startsWith('image')) type = 'photos';
        } else if (entry.fields.videoEmbedUrl) {
          type = 'videos';
        }
      }
      entry.fileType = type;

      locationsData.forEach(locData => {
        const locationKey = locData.locationName.toLowerCase();
        if (!newLocationCounts[locationKey]) {
          newLocationCounts[locationKey] = { total: 0, albums: 0, photos: 0, videos: 0, audio: 0, documents: 0, coordinates: locData.coordinates, description: locData.description };
        }
        newLocationCounts[locationKey].total++;
        if (type && newLocationCounts[locationKey][type] !== undefined) {
          newLocationCounts[locationKey][type]++;
        }

        const islandKey = locData.safeIslandText;
        if (!newIslandCounts[islandKey]) {
          newIslandCounts[islandKey] = { total: 0, albums: 0, photos: 0, videos: 0, audio: 0, documents: 0 };
        }
        newIslandCounts[islandKey].total++;
        if (type && newIslandCounts[islandKey][type] !== undefined) {
          newIslandCounts[islandKey][type]++;
        }
      });
    });

    return { islandCounts: newIslandCounts, locationCounts: newLocationCounts };
  }

  function extractYouTubeVideoId(url) {
    const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const match = url.match(regex);
    return (match && match[1]) ? match[1] : null;
  }

  function renderPreviewItems(entries) {
    const previewContainer = document.getElementById('archive-previews');
    previewContainer.innerHTML = '';

    entries.forEach(item => {
      const fields = item.fields;
      const title = fields.title || 'Untitled';
      const date = fields.date ? new Date(fields.date).getFullYear() : 'Unknown year';

      const locationsData = resolveLocationAndIsland(item);
      const locationNames = locationsData.map(loc => {
        if (loc.locationName !== loc.islandName && loc.locationName !== 'Unknown Location') {
          return `${loc.locationName}, ${loc.islandName}`;
        }
        return loc.locationName;
      }).join(' & ');

      let imageUrl = null;
      let thumbnailClass = ''

      const mediaAsset = fields.media?.sys?.id ? allAssets.find(a => a.sys.id === fields.media.sys.id) : null;
      if (mediaAsset?.fields?.file?.url) {
        const contentType = mediaAsset.fields.file.contentType;
        if (contentType.startsWith('image/')) {
          imageUrl = `https:${mediaAsset.fields.file.url}`;
        } else if (contentType.includes('pdf')) {
          const thumbAsset = fields.thumbnailImage?.sys?.id ? allAssets.find(a => a.sys.id === fields.thumbnailImage.sys.id) : null;
          if (thumbAsset?.fields?.file?.url) {
            imageUrl = `https:${thumbAsset.fields.file.url}`;
          } else {
            imageUrl = 'icons/document-icon.svg';
            thumbnailClass = 'icon-thumbnail';
          }
        } else if (contentType.startsWith('audio')) {
          imageUrl = 'icons/audio-icon.svg';
          thumbnailClass = 'icon-thumbnail';
        }
      } else if (fields.thumbnailImage?.sys?.id) {
        const thumbAsset = allAssets.find(a => a.sys.id === fields.thumbnailImage.sys.id);
        if (thumbAsset?.fields?.file?.url) {
          imageUrl = `https:${thumbAsset.fields.file.url}`;
        }
      } else if (fields.imageGallery?.length) {
        const firstGalleryImage = allAssets.find(a => a.sys.id === fields.imageGallery[0].sys.id);
        if (firstGalleryImage?.fields?.file?.url) {
          imageUrl = `https:${firstGalleryImage.fields.file.url}`;
        }
      } else if (fields.videoEmbedUrl) {
        const videoId = extractYouTubeVideoId(fields.videoEmbedUrl);
        if (videoId) {
          imageUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
        }
      }

      let imageHtml = '';
      if (imageUrl) {
        imageHtml = `<img src="${imageUrl}" alt="${title}" class="${thumbnailClass}"/>`;
      }

      const cardLink = document.createElement('a');
      cardLink.className = 'archive-card';
      cardLink.href = `entry.html?id=${item.sys.id}`;
      cardLink.innerHTML = `
        ${imageHtml}
        <div class="card-text">
          <h3>${title}</h3>
          <p>${date} </p>
          <p>${locationNames}</p>
        </div>
      `;

      cardLink.addEventListener('click', (event) => {
        event.preventDefault();
        window.location.href = `entry.html?id=${item.sys.id}`;
      });

      previewContainer.appendChild(cardLink);
    });

    if (entries.length === 0) {
      previewContainer.innerHTML = '<p>No entries found.</p>';
      return;
    }
  }

  mapboxgl.accessToken = 'pk.eyJ1IjoiYmlhcmNoaXZlcyIsImEiOiJjbWRtZDRmMjIxa3JlMmpxMWIyM2ZleHVoIn0.qAlCMwvS56lvr7AbC2Iuug';
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/biarchives/cmdop5iqf01vp01sa2ol5fds9',
    center: defaultCenter,
    zoom: defaultZoom
  });

  map.addControl(new mapboxgl.NavigationControl());
  map.scrollZoom.disable();

  function showSidebarAndFlyTo(props, location, island, coordinates) {
      if (!coordinates) return;

      map.flyTo({
        center: coordinates,
        zoom: 12,
        speed: 1,
        curve: 1,
        essential: true
      });

      const stats = locationCounts[location.toLowerCase()] || { total: 0, albums: 0, photos: 0, videos: 0, audio: 0, documents: 0 };
      
      document.getElementById('sidebar-title').textContent = location || "Untitled Location";
      document.getElementById('sidebar-subtitle').textContent = island || "";
      document.getElementById('sidebar-description').textContent = props.description || "";

      document.getElementById('archive-buttons').innerHTML = `
        <button id="btn-all" data-filter-type="all">View All (${stats.total})</button>
        <button id="btn-albums" data-filter-type="albums">Albums (${stats.albums})</button>
        <button id="btn-photos" data-filter-type="photos">Photos (${stats.photos})</button>
        <button id="btn-videos" data-filter-type="videos">Videos (${stats.videos})</button>
        <button id="btn-audio" data-filter-type="audio">Audio (${stats.audio})</button>
        <button id="btn-documents" data-filter-type="documents">Documents (${stats.documents})</button>
      `;
      document.getElementById('sidebar').classList.remove('hidden');
      document.getElementById('sidebar').setAttribute('aria-hidden', 'false');
      attachButtonListeners(location.toLowerCase(), 'location');
  }

  function showIslandSidebar(islandName, islandDescription) {
    const safeIslandName = islandName.toLowerCase().trim();
    const stats = islandCounts[safeIslandName] || { total: 0, albums: 0, photos: 0, videos: 0, audio: 0, documents: 0 };

    document.getElementById('sidebar-title').textContent = islandName || "";
    document.getElementById('sidebar-subtitle').textContent = "";
    document.getElementById('sidebar-description').textContent = islandDescription || "";

    document.getElementById('archive-buttons').innerHTML = `
      <button id="btn-all" data-filter-type="all">View All (${stats.total})</button>
      <button id="btn-albums" data-filter-type="albums">Albums (${stats.albums})</button>
      <button id="btn-photos" data-filter-type="photos">Photos (${stats.photos})</button>
      <button id="btn-videos" data-filter-type="videos">Videos (${stats.videos})</button>
      <button id="btn-audio" data-filter-type="audio">Audio (${stats.audio})</button>
      <button id="btn-documents" data-filter-type="documents">Documents (${stats.documents})</button>
    `;
    document.getElementById('sidebar').classList.remove('hidden');
    document.getElementById('sidebar').setAttribute('aria-hidden', 'false');
    attachButtonListeners(safeIslandName, 'island');
    hideMapMenu();
  }

  function attachButtonListeners(selectedName, type) {
    const buttons = document.querySelectorAll('#archive-buttons button');
    buttons.forEach(button => {
      button.addEventListener('click', () => {
        const filterType = button.dataset.filterType;
        let filteredEntries = [];

        filteredEntries = allEntries.filter(entry => {
          const locationsData = resolveLocationAndIsland(entry);
          let matchesName = false;

          if (type === 'island') {
            matchesName = locationsData.some(loc => loc.safeIslandText === selectedName);
          } else if (type === 'location') {
            matchesName = locationsData.some(loc => loc.locationName.toLowerCase() === selectedName);
          }
          const matchesType = filterType === 'all' || entry.fileType === filterType;
          return matchesName && matchesType;
        });

        renderPreviewItems(filteredEntries);
        document.getElementById('archive-overlay').classList.remove('hidden');
        document.getElementById('archive-overlay').setAttribute('aria-hidden', 'false');
        hideMapMenu();
      });
    });
  }

  function hideMapMenu() {
    document.getElementById('map-menu').classList.add('hidden-menu');
  }
  
  function showMapMenu() {
    document.getElementById('map-menu').classList.remove('hidden-menu');
  }

  function populateMapMenu() {
    const islandsData = {};
    allEntries.forEach(entry => {
      const locations = resolveLocationAndIsland(entry);
      locations.forEach(loc => {
        if (!islandsData[loc.islandName]) {
          islandsData[loc.islandName] = { locations: new Set(), description: loc.description };
        }
        islandsData[loc.islandName].locations.add(loc.locationName);
      });
    });
    
    const islandList = document.getElementById('island-list');
    islandList.innerHTML = '';
    const sortedIslands = Object.keys(islandsData).sort();

    sortedIslands.forEach(islandName => {
      if (islandName === 'Unknown Island') return;

      const islandItem = document.createElement('li');
      islandItem.textContent = islandName;
      islandItem.style.fontWeight = 'bold';

      const locationsForIsland = Array.from(islandsData[islandName].locations);

      const hasGeolocations = locationsForIsland.length > 1 || (locationsForIsland.length === 1 && locationsForIsland[0] !== islandName);
      
      if (hasGeolocations) {
        const locationList = document.createElement('ul');
        locationList.classList.add('location-list');
        locationList.style.display = 'none';

        islandItem.addEventListener('click', () => {
          const isHidden = locationList.style.display === 'none';
          locationList.style.display = isHidden ? 'block' : 'none';
        });

        const sortedLocations = locationsForIsland.sort((a, b) => a.localeCompare(b));

        sortedLocations.forEach(locationName => {
          if (locationName === 'Unknown Location') return;
          
          const locationItem = document.createElement('li');
          locationItem.textContent = locationName;
          locationItem.classList.add('location-item');
          locationItem.dataset.locationName = locationName;
          locationItem.dataset.islandName = islandName;
          locationItem.addEventListener('click', (event) => {
            event.stopPropagation();
            const clickedLocationName = event.target.dataset.locationName;
            const clickedIslandName = event.target.dataset.islandName;
            
            const features = map.querySourceFeatures('composite', {
              sourceLayer: 'BIArchives_Geolocations',
              filter: [
                'all',
                ['==', ['downcase', ['get', 'location']], clickedLocationName.toLowerCase()],
                ['==', ['downcase', ['get', 'island']], clickedIslandName.toLowerCase()]
              ]
            });

            if (features.length > 0) {
              const feature = features[0];
              const coordinates = feature.geometry.coordinates;
              const props = feature.properties;
              showSidebarAndFlyTo(props, props.location, props.island, coordinates);
              hideMapMenu();
            } else {
              console.warn(`No Mapbox feature found for location: ${clickedLocationName} on island: ${clickedIslandName}. Source: composite, Source-layer: BIArchives_Geolocations`);
            }
          });
          locationList.appendChild(locationItem);
        });
        
        islandItem.appendChild(locationList);
        islandList.appendChild(islandItem);
      } else {
        islandItem.addEventListener('click', () => {
          showIslandSidebar(islandName, islandsData[islandName].description);
        });
        islandList.appendChild(islandItem);
      }
    });
  }

  map.on('load', async () => {
    allEntries = await fetchAllEntries();
    // Correctly assign the returned counts to the global variables
    const counts = groupEntries(allEntries);
    islandCounts = counts.islandCounts;
    locationCounts = counts.locationCounts;
    
    populateMapMenu();

    const hoverPopup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });
    let hoveredFeatureId = null;

    map.on('mouseenter', 'bay-island-islands-fill', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'bay-island-islands-fill', () => map.getCanvas().style.cursor = '');

    map.on('mousemove', 'biarchives-geolocations', (e) => {
      if (e.features.length > 0) {
        const feature = e.features[0];
        const featureId = feature.id;

        if (featureId !== hoveredFeatureId) {
          hoveredFeatureId = featureId;

          const coordinates = feature.geometry.coordinates.slice();
          const locationName = feature.properties.location || "Unnamed Location";

          hoverPopup
            .setLngLat(coordinates)
            .setHTML(`<strong>${locationName}</strong>`)
            .addTo(map);
        }
      } else {
        if (hoveredFeatureId !== null) {
          hoveredFeatureId = null;
          hoverPopup.remove();
        }
      }
    });

    map.on('mouseleave', 'biarchives-geolocations', () => {
      hoveredFeatureId = null;
      hoverPopup.remove();
    });

    map.on('click', 'bay-island-islands-fill', (e) => {
      const props = e.features[0].properties;
      const island = props.island || "";
      showIslandSidebar(island, props.description);
    });

    map.on('click', 'biarchives-geolocations', (e) => {
      const props = e.features[0].properties;
      const coordinates = e.features[0].geometry.coordinates.slice();
      showSidebarAndFlyTo(props, props.location, props.island, coordinates);
      hideMapMenu();
    });

    document.getElementById('menu-toggle-button').addEventListener('click', () => {
      const menuContent = document.getElementById('menu-content');
      const isExpanded = menuContent.classList.toggle('expanded');
      document.getElementById('menu-toggle-button').setAttribute('aria-expanded', isExpanded);
      menuContent.setAttribute('aria-hidden', !isExpanded);
    });

    document.getElementById('back-button').addEventListener('click', () => {
      map.flyTo({
        center: defaultCenter,
        zoom: defaultZoom,
        speed: 1,
        curve: 1,
        essential: true
      });
      document.getElementById('sidebar').classList.add('hidden')
      document.getElementById('sidebar').setAttribute('aria-hidden', 'true');
      document.getElementById('archive-previews').innerHTML = '';
      const overlay = document.getElementById('archive-overlay');
      overlay.classList.add('hidden');
      overlay.style.display = '';
      overlay.setAttribute('aria-hidden', 'true');
      showMapMenu();
    });
  });
</script>

</html>